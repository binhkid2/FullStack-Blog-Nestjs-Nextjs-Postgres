{% if posts.length == 0 %}
<div class="rounded-xl border border-dashed border-zinc-300 bg-zinc-50 p-5 text-sm text-zinc-600">
  No posts yet.
</div>
{% else %}
<div class="grid gap-4">
  {% for post in posts %}
  <article class="rounded-xl border border-zinc-200 bg-white p-4 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div class="space-y-1">
        <a href="/blog/{{ post.slug }}" class="font-[Source_Serif_4] text-2xl font-semibold text-zinc-900 transition hover:text-teal-700">{{ post.title }}</a>
        <p class="text-xs text-zinc-500">/{{ post.slug }}</p>
        <div class="flex flex-wrap gap-2 pt-1">
          <span class="inline-flex items-center rounded-full border border-teal-200 bg-teal-50 px-2.5 py-0.5 text-xs font-medium uppercase tracking-wide text-teal-700">{{ post.status }}</span>
          <span class="inline-flex items-center rounded-full border border-zinc-200 bg-zinc-100 px-2.5 py-0.5 text-xs font-medium text-zinc-600">{{ post.views }} views</span>
          {% if post.isFeatured %}
          <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-0.5 text-xs font-medium text-amber-700">featured</span>
          {% endif %}
          <span class="inline-flex items-center rounded-full border border-zinc-200 bg-zinc-50 px-2.5 py-0.5 text-xs font-medium text-zinc-600">Author: {{ post.author.name if post.author else "Unknown" }}</span>
        </div>
      </div>

      <a href="/blog/{{ post.slug }}" class="rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm font-medium text-zinc-700 no-underline transition hover:border-teal-500 hover:text-teal-700">View post</a>
    </div>

    {% if post.featuredImage %}
    <div class="mt-3 overflow-hidden rounded-lg border border-zinc-200">
      <img src="{{ post.featuredImage.url }}" alt="{{ post.featuredImage.alt }}" class="h-44 w-full object-cover" loading="lazy" />
    </div>
    {% endif %}

    <p class="mt-3 text-sm text-zinc-600">{{ post.excerpt or "No excerpt." }}</p>

    <div class="mt-3 flex flex-wrap gap-2">
      {% for cat in post.categories %}
      <span class="inline-flex items-center rounded-full border border-indigo-200 bg-indigo-50 px-2 py-0.5 text-xs font-medium text-indigo-700">{{ cat }}</span>
      {% endfor %}
      {% for tag in post.tags %}
      <span class="inline-flex items-center rounded-full border border-sky-200 bg-sky-50 px-2 py-0.5 text-xs font-medium text-sky-700">#{{ tag }}</span>
      {% endfor %}
    </div>

    {% if currentUser.role == "ADMIN" %}
    <details class="mt-4 rounded-lg border border-zinc-200 bg-zinc-50 p-3">
      <summary class="cursor-pointer text-sm font-semibold text-zinc-800">Edit this post</summary>

      <form
        hx-patch="/blog-posts/{{ post.id }}"
        hx-target="#flash"
        hx-swap="innerHTML"
        hx-on::after-request="refreshDashboardPosts()"
        class="mt-3 space-y-3"
      >
        <div class="grid gap-2 md:grid-cols-2">
          <input name="title" value="{{ post.title }}" required class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
          <input name="slug" value="{{ post.slug }}" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
        </div>

        <textarea name="excerpt" class="min-h-20 w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">{{ post.excerpt }}</textarea>
        <textarea name="content" class="min-h-36 w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">{{ post.content }}</textarea>

        <div class="grid gap-2 sm:grid-cols-3">
          <select name="contentFormat" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">
            <option value="markdown" {% if post.contentFormat == "markdown" %}selected{% endif %}>Markdown</option>
            <option value="html" {% if post.contentFormat == "html" %}selected{% endif %}>HTML</option>
          </select>
          <select name="status" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">
            <option value="draft" {% if post.status == "draft" %}selected{% endif %}>draft</option>
            <option value="published" {% if post.status == "published" %}selected{% endif %}>published</option>
            <option value="archived" {% if post.status == "archived" %}selected{% endif %}>archived</option>
          </select>
          <select name="isFeatured" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">
            <option value="false" {% if not post.isFeatured %}selected{% endif %}>not featured</option>
            <option value="true" {% if post.isFeatured %}selected{% endif %}>featured</option>
          </select>
        </div>

        <div class="grid gap-2 md:grid-cols-2">
          <input name="categories" value="{{ post.categories | join(',') }}" placeholder="Categories: backend,api" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
          <input name="tags" value="{{ post.tags | join(',') }}" placeholder="Tags: rest,pagination" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
        </div>

        <div class="grid gap-2 md:grid-cols-2">
          <input name="featuredImageUrl" value="{{ post.featuredImage.url if post.featuredImage else '' }}" placeholder="Featured image URL (optional)" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
          <input name="featuredImageAlt" value="{{ post.featuredImage.alt if post.featuredImage else '' }}" placeholder="Featured image ALT (optional)" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" />
        </div>

        <div class="flex flex-wrap items-center justify-between gap-2">
          <p class="text-xs text-zinc-500">To remove image: clear the URL field and save changes.</p>
          <button class="rounded-lg bg-teal-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-teal-700" type="submit">Save changes</button>
        </div>
      </form>
    </details>

    <button
      class="mt-3 rounded-lg border border-rose-200 bg-white px-3 py-2 text-sm font-medium text-rose-700 transition hover:bg-rose-50"
      type="button"
      hx-delete="/blog-posts/{{ post.id }}"
      hx-target="#flash"
      hx-swap="innerHTML"
      hx-confirm="Delete this post permanently?"
      hx-on::after-request="refreshDashboardPosts()"
    >
      Delete post
    </button>
    {% else %}
    <p class="mt-3 text-sm text-zinc-500">Read-only for {{ currentUser.role }} role.</p>
    {% endif %}
  </article>
  {% endfor %}
</div>
{% endif %}
