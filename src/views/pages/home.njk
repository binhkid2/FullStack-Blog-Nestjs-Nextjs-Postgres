{% extends "layouts/base.njk" %}

{% block body %}
<section class="rounded-2xl border border-zinc-200 bg-white p-5 shadow-sm">
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div class="max-w-3xl">
      <h1 class="font-[Source_Serif_4] text-4xl font-semibold leading-tight text-zinc-900">Practical Engineering Stories</h1>
      <p class="mt-2 text-zinc-600">Fast backend patterns, frontend craft, and product lessons from shipping real systems.</p>
    </div>

    <div class="flex flex-wrap justify-end gap-2">
      {% for c in topCategories %}
      <button
        class="rounded-full border border-zinc-200 bg-zinc-50 px-3 py-1.5 text-sm font-medium text-zinc-700 transition hover:border-teal-500 hover:text-teal-700"
        type="button"
        hx-get="/blog-posts/partials/grid?page=1&pageSize={{ query.pageSize }}&q=&tags=&category={{ c.name | urlencode }}&sort={{ query.sort }}"
        hx-target="#post-grid-container"
        hx-swap="innerHTML"
      >
        {{ c.name }} ({{ c.count }})
      </button>
      {% endfor %}
    </div>
  </div>
</section>

<section class="rounded-2xl border border-zinc-200 bg-gradient-to-r from-white via-sky-50 to-emerald-50 p-5 shadow-sm">
  <div class="grid gap-4 lg:grid-cols-[minmax(0,1.5fr)_minmax(0,1fr)]">
    {% if featured and featured.length > 0 %}
    <article class="rounded-xl border border-dashed border-teal-200 bg-white/80 p-5">
      <p class="mb-3 inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-2.5 py-0.5 text-xs font-semibold uppercase tracking-wide text-amber-700">Featured pick</p>
      <h2 class="font-[Source_Serif_4] text-3xl font-semibold leading-tight text-zinc-900">
        <a href="/blog/{{ featured[0].slug }}" class="transition hover:text-teal-700">{{ featured[0].title }}</a>
      </h2>
      <p class="mt-3 text-zinc-600">{{ featured[0].excerpt }}</p>
      <p class="mt-3 text-sm font-medium text-zinc-500">{{ featured[0].views }} views</p>
    </article>
    {% endif %}

    <div class="grid gap-3">
      {% for post in featured %}
      {% if loop.index0 > 0 %}
      <article class="rounded-xl border border-zinc-200 bg-white/80 p-4">
        <h3 class="font-[Source_Serif_4] text-xl font-semibold text-zinc-900">
          <a href="/blog/{{ post.slug }}" class="transition hover:text-teal-700">{{ post.title }}</a>
        </h3>
        <p class="mt-2 text-sm text-zinc-600">{{ post.excerpt }}</p>
      </article>
      {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<section class="grid items-start gap-4 lg:grid-cols-[minmax(0,1fr)_20rem]">
  <div>
    <form
      id="home-filter-form"
      class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm"
      hx-get="/blog-posts/partials/grid"
      hx-target="#post-grid-container"
      hx-swap="innerHTML"
      hx-trigger="submit, keyup changed delay:450ms from:#q, keyup changed delay:450ms from:#tags, change delay:150ms from:#category, change delay:150ms from:#sort"
    >
      <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-4">
        <div class="md:col-span-2">
          <label for="q" class="mb-1 block text-sm font-medium text-zinc-600">Search title + excerpt</label>
          <input id="q" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" name="q" type="search" placeholder="Search posts" value="{{ query.q }}" />
        </div>

        <div>
          <label for="category" class="mb-1 block text-sm font-medium text-zinc-600">Category</label>
          <select id="category" name="category" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">
            <option value="">All</option>
            {% for c in topCategories %}
            <option value="{{ c.name }}" {% if query.category == c.name %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="sort" class="mb-1 block text-sm font-medium text-zinc-600">Sort</label>
          <select id="sort" name="sort" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none">
            <option value="newest" {% if query.sort == "newest" %}selected{% endif %}>Newest</option>
            <option value="oldest" {% if query.sort == "oldest" %}selected{% endif %}>Oldest</option>
            <option value="most_viewed" {% if query.sort == "most_viewed" %}selected{% endif %}>Most viewed</option>
            <option value="featured" {% if query.sort == "featured" %}selected{% endif %}>Featured first</option>
          </select>
        </div>
      </div>

      <div class="mt-3 grid gap-3 md:grid-cols-[minmax(0,1fr)_auto] md:items-end">
        <div>
          <label for="tags" class="mb-1 block text-sm font-medium text-zinc-600">Tags (comma separated)</label>
          <input id="tags" class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" name="tags" value="{{ query.tags }}" placeholder="nextjs, ui" />
        </div>
        <div class="flex gap-2">
          <input type="hidden" name="page" value="1" />
          <input type="hidden" name="pageSize" value="{{ query.pageSize }}" />
          <button type="submit" class="rounded-lg bg-teal-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-teal-700">Apply</button>
        </div>
      </div>
    </form>

    <div id="post-grid-container" class="mt-4">
      {% set result = posts %}
      {% include "partials/post-grid.njk" %}
    </div>
  </div>

  <aside class="grid gap-4">
    <section class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
      <h3 class="font-[Source_Serif_4] text-2xl font-semibold text-zinc-900">Popular Posts</h3>
      <div class="mt-3 grid gap-2">
        {% for item in popularPosts %}
        <a href="/blog/{{ item.slug }}" class="flex items-center justify-between rounded-lg border border-zinc-200 bg-zinc-50 px-3 py-2 text-sm font-medium text-zinc-700 no-underline transition hover:border-teal-500 hover:text-teal-700">
          <span>{{ item.title }}</span>
          <span class="text-zinc-500">{{ item.views }}</span>
        </a>
        {% endfor %}
      </div>
    </section>

    <section class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
      <h3 class="font-[Source_Serif_4] text-2xl font-semibold text-zinc-900">Newsletter</h3>
      <p class="mt-1 text-sm text-zinc-600">One practical note every Friday.</p>
      <form hx-post="/auth/magic-link" hx-target="#flash" hx-swap="innerHTML" class="mt-3">
        <input class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-teal-500 focus:outline-none" type="email" name="email" placeholder="you@example.com" required />
        <button class="mt-2 w-full rounded-lg bg-teal-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-teal-700" type="submit">Join</button>
      </form>
    </section>

    <section class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
      <h3 class="font-[Source_Serif_4] text-2xl font-semibold text-zinc-900">Tag Cloud</h3>
      <div class="mt-3 flex flex-wrap gap-2">
        {% for tag in topTags %}
        <button
          type="button"
          class="rounded-full border border-teal-200 bg-teal-50 px-2.5 py-1 text-xs font-medium text-teal-700 transition hover:border-teal-400 hover:bg-teal-100"
          hx-get="/blog-posts/partials/grid?page=1&pageSize={{ query.pageSize }}&q=&tags={{ tag.name | urlencode }}&category=&sort={{ query.sort }}"
          hx-target="#post-grid-container"
          hx-swap="innerHTML"
        >
          #{{ tag.name }} ({{ tag.count }})
        </button>
        {% endfor %}
      </div>
    </section>

    <section class="rounded-2xl border border-zinc-200 bg-gradient-to-r from-amber-50 to-orange-50 p-4 shadow-sm">
      <h3 class="font-[Source_Serif_4] text-2xl font-semibold text-zinc-900">Ad Space</h3>
      <p class="mt-1 text-sm text-zinc-600">Placeholder for sponsor content.</p>
    </section>
  </aside>
</section>

<footer class="rounded-2xl border border-zinc-200 bg-white p-4 text-center text-sm text-zinc-600 shadow-sm">
  Built with Fastify + HTMX + Mongoose
</footer>
{% endblock %}
